## Vault secrets storage

### Installation

```
make vault
```
Will install;
- Vault, with the following secrets engines;
  - /secrets - a KV1 secret store
  - /pki-$base_domain - a PKI engine for the public facing domain
  - /pki-$private_base_domain - a PKI engine for the private internal domain
- vault-crd - For syncing secrets from the /secrets engine, See below for further details
- cert-manager ClusterIssuers - One for each of the above PKI engines, see below for further details 
 
### Vault integration options

The below options were explored for use alongside payment manager, however may be applicable in other use cases too. 

- vault-agent-injector
  
  The vault [agent sidecar injector](https://www.vaultproject.io/docs/platform/k8s/injector) is a solution from Hashicorp which allows dynamically adding a sidecar container to a pod for allowing access to vault secrets. When configured, this agent creates a shared volume where secrets are written to allow an application which is not vault-aware to read secrets from disk.
  This is not currently enabled but can be done so by modifying the vault values file for helm. 
- cert-manager
  
  A [vault issuer](https://cert-manager.io/docs/configuration/vault/) can be deployed which allows cert-manager to request certs from a PKI engine in vault. This is the most straightforward option for using certificates from a vault PKI engine alongside kubernetes ingress.
  However, as this requires vault to be used as the CA, this option requires work in payment manager. This solution may be implemented in future. 

  The vault-issuer and vault-issuer-internal ClusterIssuers are installed and configured in the cluster and can be used by an ingress object as per https://cert-manager.io/docs/usage/ingress/
- vault-crd
  
  The [vault-crd](https://vault.koudingspawn.de/) project synchronises secrets stored in Vault with kubernetes secrets. This has potential for many different scenarios, however of particular use for payment manager, secrets can stored in vault by payment manager, which are then synchronised to kubernetes secrets and in turn are then utilised by the ingress controller. 

### vault-crd secrets integration
  Once vault and vault-crd has been deployed using the included playbook, the below steps will allow certs generated by payment manager to be used by the ingress controller.

  - Certificates generated by payment manager are stored in vault in a KV1 secret in json format. 
    Example json format;
      ```
      {
        "request_id": "<guid>",
        "lease_id": "",
        "lease_duration": 0,
        "renewable": false,
        "data": {
          "certificate": "-----BEGIN CERTIFICATE-----\nMIID3TCCAsWgAwI...\n-----END CERTIFICATE-----",
          "expiration": 1611399831,
          "issuing_ca": "-----BEGIN CERTIFICATE-----\nMIIDNTCCAh2gAwIB...\n-----END CERTIFICATE-----",
          "private_key": "-----BEGIN RSA PRIVATE KEY-----\nMIIEpAIBAAKCAQEA...\n-----END RSA PRIVATE KEY-----",
          "private_key_type": "rsa",
          "serial_number": "<cert serial number>"
        },
        "warnings": null
      }
      ```
  - vault-crd object created, specifying the path of the above secret and the kubernetes secret where it will be stored
    Example vault-crd yaml;
      ```
      apiVersion: "koudingspawn.de/v1"
      kind: Vault
      metadata:
        name: dfsp-secret-tls
      spec:
        path: "secrets/dfsp-secret"
        type: "KEYVALUE"
      ```
  - When creating the ingress, specify the above secret created by vault-crd
    Example ingress yaml;
      ```
      apiVersion: extensions/v1beta1
      kind: Ingress
      ...
        tls:
        - hosts:
          - dfsp.somedomain.com
          secretName: dfsp-secret-tls
      ...
      ```
  - See vault-crd docs for [Secret Type - CERT](https://vault.koudingspawn.de/supported-secret-types/secret-type-cert) for further info on above

